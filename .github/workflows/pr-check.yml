name: PR Build Check

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read

jobs:
  build-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Cache build repositories
        uses: actions/cache@v3
        with:
          path: |
            repos/linux
            repos/u-boot
            repos/dt-overlays
            downloads
          key: ${{ runner.os }}-build-cache-${{ hashFiles('scripts/banapro/common.sh') }}
          restore-keys: |
            ${{ runner.os }}-build-cache-
      
      - name: Install dependencies
        run: |
          # Free up disk space
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get update
          sudo apt-get install -y \
            gcc-arm-linux-gnueabihf flex bison bc libssl-dev make git wget \
            device-tree-compiler u-boot-tools swig python3-dev python3-setuptools \
            libgnutls28-dev libncurses-dev libarchive-tools rsync dosfstools util-linux e2fsprogs
      
      - name: Build BananaPro image
        run: |
          # Build the complete image to verify it works
          chmod +x scripts/banapro.sh
          sudo -E ./scripts/banapro.sh build 2>&1 | tee build.log
        env:
          JOBS: 2
        timeout-minutes: 300
      
      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-build-log
          path: build.log
          retention-days: 7
      
      - name: Verify artifacts
        run: |
          ARTIFACTS_DIR="artifacts/banapro"
          
          # Check that the image was created
          if [ ! -f "${ARTIFACTS_DIR}/archlinuxarm-bananapro.img" ]; then
            echo "Error: Image file not created"
            exit 1
          fi
          
          # Check image size is reasonable (at least 100MB)
          IMAGE_SIZE=$(stat -c%s "${ARTIFACTS_DIR}/archlinuxarm-bananapro.img")
          MIN_SIZE=$((100 * 1024 * 1024))
          if [ "${IMAGE_SIZE}" -lt "${MIN_SIZE}" ]; then
            echo "Error: Image file too small (${IMAGE_SIZE} bytes)"
            exit 1
          fi
          
          echo "✓ Build verification successful"
          echo "  Image size: $(( IMAGE_SIZE / 1024 / 1024 )) MB"
          
          # List all generated artifacts
          echo "Generated artifacts:"
          ls -lh "${ARTIFACTS_DIR}/"
      
      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const artifactsDir = 'artifacts/banapro';
            const imgFile = `${artifactsDir}/archlinuxarm-bananapro.img`;
            
            let imgSize = 0;
            if (fs.existsSync(imgFile)) {
              const stats = fs.statSync(imgFile);
              imgSize = (stats.size / 1024 / 1024).toFixed(2);
            }
            
            const comment = `## ✅ Build Check Passed
            
            The BananaPro image build completed successfully!
            
            **Build Details:**
            - Image size: ${imgSize} MB
            - Build logs available in workflow artifacts
            
            The image is ready for release once this PR is merged to \`main\`.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
